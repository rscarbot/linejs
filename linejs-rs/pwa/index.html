<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#06C755">
  <meta name="description" content="Driver Messaging Client">
  <link rel="manifest" href="manifest.json">
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>">
  <title>Dispatcher Messenger</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="header">
    <span style="font-size: 22px;">üí¨</span>
    <h1>Dispatcher Messenger</h1>
    <div class="status-dot" id="status-dot"></div>
    <button id="btn-logout" onclick="doLogout()"
      style="display:none; background:none; border:none; color:white; font-size:20px; cursor:pointer; margin-left:8px;"
      title="Logout">üö™</button>
  </div>

  <div class="container">
    <!-- Login Screen -->
    <div class="screen active" id="login-screen">
      <div class="login-logo">üîê</div>
      <div class="login-title">Dispatcher Messenger</div>
      <div class="login-desc">
        End-to-end encrypted messaging.
        Login with your LINE account via QR code.
      </div>

      <div class="device-selector"
        style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; justify-content: center;">
        <label for="device-mode" style="font-size: 14px; font-weight: 600;">Device Mode:</label>
        <select id="device-mode"
          style="padding: 8px; border-radius: 8px; border: 1px solid #ddd; background: #f5f5f5; font-size: 14px;">
          <option value="ipad" selected>iPad (Default)</option>
          <option value="desktop">PC (Windows)</option>
        </select>
      </div>

      <button class="btn btn-primary" id="btn-login" onclick="startLogin()">
        Apply
      </button>
    </div>

    <!-- QR Code Screen -->
    <div class="screen" id="qr-screen">
      <div class="qr-label">Scan QR Code</div>
      <div class="qr-sublabel">Open LINE on your phone and scan this code</div>
      <div class="qr-container">
        <a id="qr-link" href="#" target="_blank" rel="noopener" style="display:inline-block; cursor:pointer;">
          <img id="qr-image" alt="QR Code" />
        </a>
        <div id="qr-timeout-overlay" class="qr-timeout-overlay" style="display: none;" onclick="retryQrLogin()">
          <div class="refresh-btn">
            <svg viewBox="0 0 24 24">
              <path
                d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
            </svg>
          </div>
          <div style="font-size: 14px; font-weight: 600; color: #333; margin-top: 12px;">Tap to reload</div>
        </div>
        <div style="font-size:12px; color:var(--text-muted); margin-top:8px;">Tap QR code to open login link</div>
      </div>
      <div class="spinner" id="qr-spinner" style="display:none;"></div>
      <div class="qr-sublabel" id="qr-status">Waiting for scan...</div>
      <button class="btn btn-secondary" onclick="switchToEmail()" style="margin-top: 10px;">
        ‚úâÔ∏è Login with Email
      </button>
      <button class="btn btn-secondary" onclick="cancelLogin()" style="margin-top: 6px;">
        <img src="cancel.png" alt="Cancel" width="18" height="18" style="vertical-align: middle;">
        Cancel
      </button>
    </div>

    <!-- Email Login Screen -->
    <div class="screen" id="email-screen">
      <!-- Deprecated: Kept for fallback if needed, but UI now uses combined-screen -->
    </div>

    <!-- Combined Login Screen -->
    <div class="screen" id="combined-screen">
      <div class="login-split-container">
        <!-- Left Section: Email Login -->
        <div class="login-section email-section">
          <div class="line-logo">LINE</div>
          <div class="input-group">
            <input type="email" id="email-input-combined" placeholder="Email address"
              oninput="checkCombinedLoginInputs()" />
            <input type="password" id="password-input-combined" placeholder="Password"
              oninput="checkCombinedLoginInputs()" />
          </div>
          <button class="btn btn-login-full" id="btn-email-login-combined" onclick="startEmailLoginCombined()" disabled>
            Login
          </button>
        </div>

        <!-- Vertical Divider -->
        <div class="vertical-divider"></div>

        <!-- Right Section: QR Code -->
        <div class="login-section qr-section">
          <div class="qr-container">
            <a id="qr-link-combined" href="#" target="_blank" rel="noopener"
              style="display:inline-block; cursor:pointer;">
              <img id="qr-image-combined" alt="QR Code" />
            </a>
            <div id="qr-timeout-overlay-combined" class="qr-timeout-overlay" style="display: none;"
              onclick="retryQrLogin()">
              <div class="refresh-btn">
                <svg viewBox="0 0 24 24">
                  <path
                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                </svg>
              </div>
              <div style="font-size: 14px; font-weight: 600; color: #333; margin-top: 12px;">Tap to reload</div>
            </div>
          </div>
          <div class="spinner" id="qr-spinner-combined" style="display:none;"></div>

          <div class="qr-label" style="margin-top: 15px; font-size: 16px; font-weight: bold;">Login with QR Code</div>

          <div class="qr-sublabel" id="qr-status-combined"
            style="text-align: center; max-width: 200px; line-height: 1.5; color: #666;">
            Open LINE on your phone and scan this code
          </div>
        </div>
      </div>
    </div>

    <!-- Email PIN Screen -->
    <div class="screen" id="email-pin-screen">
      <div style="font-size: 40px;">üì±</div>
      <div class="qr-label">Enter PIN Code</div>
      <div class="qr-sublabel">Enter this code on your mobile device to confirm</div>
      <div class="pin-display" id="email-pin-display">------</div>
      <div class="spinner" id="email-pin-spinner"></div>
      <div class="qr-sublabel" id="email-pin-status">Waiting for verification...</div>
      <button class="btn btn-secondary" onclick="cancelPinLogin()" style="margin-top: 20px;">Cancel</button>
    </div>

    <!-- PIN Screen -->
    <div class="screen" id="pin-screen">
      <div style="font-size: 40px;">üì±</div>
      <div class="qr-label">Enter PIN Code</div>
      <div class="qr-sublabel">Enter this code on your mobile device</div>
      <div class="pin-display" id="pin-display">------</div>
      <div class="spinner" id="pin-spinner"></div>
      <div class="qr-sublabel" id="pin-status">Waiting for verification...</div>
      <button class="btn btn-secondary" onclick="cancelPinLogin()" style="margin-top: 20px;">Cancel</button>
    </div>

    <!-- Chat Screen -->
    <div class="screen" id="chat-screen">
      <div class="messages-container" id="messages-container">
        <div class="message system">Waiting for messages...</div>
      </div>
    </div>
  </div>

  <div class="status-bar" id="status-bar">Initializing WASM runtime...</div>

  <button class="log-toggle" onclick="toggleLog()">Console</button>
  <div class="log-panel" id="log-panel"></div>

  <script type="module">
    import init, { LineClient } from './pkg/linejs_wasm.js';

    let client = null;
    let pollInterval = null;
    let loginGen = 0; // Generation counter to stop old polls
    let msgPollGen = 0; // Generation counter for message polling

    // Expose functions to global scope for onclick handlers
    window.startLogin = startLogin;
    window.toggleLog = toggleLog;
    window.doLogout = doLogout;
    window.cancelLogin = cancelLogin;
    window.cancelPinLogin = cancelPinLogin;

    // Combined Login Functions
    window.startEmailLoginCombined = startEmailLoginCombined;
    window.checkCombinedLoginInputs = checkCombinedLoginInputs;
    window.retryQrLogin = retryQrLogin;
    window.showQrTimeout = showQrTimeout;

    function checkCombinedLoginInputs() {
      const email = document.getElementById('email-input-combined').value.trim();
      const password = document.getElementById('password-input-combined').value;
      const btn = document.getElementById('btn-email-login-combined');
      if (email && password) {
        btn.disabled = false;
        btn.classList.add('active');
        btn.style.background = '#06C755';
      } else {
        btn.disabled = true;
        btn.classList.remove('active');
        btn.style.background = '#c3c3c3';
      }
    }

    function doLogout() {
      localStorage.removeItem('line_credentials');
      setOnline(false);
      document.getElementById('btn-logout').style.display = 'none';
      document.getElementById('btn-login').disabled = false;
      document.getElementById('btn-login').textContent = 'Apply';
      document.getElementById('messages-container').innerHTML = '<div class="message system">Waiting for messages...</div>';
      showScreen('login-screen');
      setStatus('Logged out. Ready to login');
      log('Logged out, credentials cleared', 'success');
      // Re-create client to clear internal state
      if (client) {
        try { client.free(); } catch (e) { }
      }
      client = new LineClient();
      loginGen++;
      msgPollGen++; // Stop any existing message polling
    }

    function cancelLogin() {
      log('Login cancelled by user');
      showScreen('login-screen');
      document.getElementById('btn-login').disabled = false;
      document.getElementById('btn-login').textContent = 'Apply';
      setStatus('Login cancelled. Ready to login');
      // Re-create client to clear login state
      if (client) {
        try { client.free(); } catch (e) { }
      }
      client = new LineClient();
      loginGen++;
    }

    function cancelPinLogin() {
      // Reuse cancelLogin logic to return to main screen and reset state
      // This avoids the network call of startLogin() which can hang or fail
      cancelLogin();
    }

    function switchToEmail() {
      // Cancel QR polling by bumping loginGen
      loginGen++;
      showScreen('email-screen');
      setStatus('Enter your email and password');
      log('Switched to email login');

      // Reset inputs
      document.getElementById('email-input').value = '';
      document.getElementById('password-input').value = '';
      checkLoginInputs();
    }

    function switchToQr() {
      // Go back to login screen so user can start QR flow fresh
      loginGen++;
      showScreen('login-screen');
      document.getElementById('btn-login').disabled = false;
      document.getElementById('btn-login').textContent = 'Apply';
      setStatus('Ready to login');
      log('Switched back to QR login');
      // Re-create client to clear email login state
      if (client) {
        try { client.free(); } catch (e) { }
      }
      client = new LineClient();
    }

    async function startEmailLoginCombined() {
      const email = document.getElementById('email-input-combined').value.trim();
      const password = document.getElementById('password-input-combined').value;
      if (!email || !password) {
        log('Please enter both email and password', 'error');
        return;
      }

      const btn = document.getElementById('btn-email-login-combined');
      btn.disabled = true;
      btn.textContent = 'Logging in...';
      setStatus('Authenticating with Email...');
      log('Starting email login...');

      // Re-create client to get fresh state (this will kill the QR polling because of client replacement)
      if (client) {
        // Note: We don't implicitly stop QR polling here via loginGen until we actually make a new client
        // But creating new client invalidates the old one. We should bump loginGen to be safe.
        try { client.free(); } catch (e) { }
      }
      loginGen++; // Stop the background QR poll

      client = new LineClient();

      const deviceMode = document.getElementById('device-mode').value;
      if (client.setDevice) {
        client.setDevice(deviceMode);
      }

      try {
        const resultStr = await client.emailLoginStart(email, password);
        const result = JSON.parse(resultStr);

        if (result.authToken) {
          // Direct success (certificate was present, no PIN needed)
          log('Email login successful!', 'success');
          const creds = client.exportCredentials();
          if (creds) {
            localStorage.setItem(CRED_KEY, creds);
            log('Credentials saved', 'success');
          }
          setStatus('Logged in - Listening for messages');
          setOnline(true);
          document.getElementById('btn-logout').style.display = '';
          showScreen('chat-screen');
          addSystemMessage('Connected! Listening for messages...');
          showScreen('chat-screen');
          addSystemMessage('Connected! Listening for messages...');
          startMessagePolling(++msgPollGen);
        } else if (result.pinCode) {
          // PIN verification required
          log('PIN required: ' + result.pinCode, 'success');
          showScreen('email-pin-screen');
          document.getElementById('email-pin-display').textContent = result.pinCode;
          setStatus('Enter PIN on your mobile device');
          setStatus('Enter PIN on your mobile device');
          pollEmailPinVerification(loginGen);
        }
      } catch (e) {
        log('Email login error: ' + e, 'error');
        setStatus('Login failed: ' + e);
        // If failed, we might want to restart the whole flow or just let them try email again.
        // For simplicity, let them try email again. But QR is dead now.
        // Ideally we should restart QR too, but that requires re-init.
        // Let's just reset the button.
      } finally {
        btn.disabled = false;
        btn.textContent = 'Login';
        // If login failed, QR is dead. Maybe we should warn user or redirect back to Apply?
        // For now, just leave as is. User can hit Cancel to restart.
      }
    }

    async function pollEmailPinVerification(gen) {
      if (gen !== loginGen) return;

      log('Waiting for email PIN verification...');
      try {
        const resultStr = await client.emailLoginCheckPin();
        if (gen !== loginGen) return;
        const result = JSON.parse(resultStr);

        if (result.authToken) {
          log('Email login completed!', 'success');
          document.getElementById('email-pin-status').textContent = 'Verified!';

          const creds = client.exportCredentials();
          if (creds) {
            localStorage.setItem(CRED_KEY, creds);
            log('Credentials saved', 'success');
          }

          setStatus('Logged in - Listening for messages');
          setOnline(true);
          document.getElementById('btn-logout').style.display = '';
          showScreen('chat-screen');
          addSystemMessage('Connected! Listening for messages...');
          showScreen('chat-screen');
          addSystemMessage('Connected! Listening for messages...');
          startMessagePolling(++msgPollGen);
        } else {
          log('PIN verification returned no token, retrying...', 'warn');
          pollEmailPinVerification(gen);
        }
      } catch (e) {
        log('Email PIN verification error: ' + e, 'error');
        document.getElementById('email-pin-status').textContent = 'Verification failed: ' + e;
        setStatus('PIN verification failed');
      }
    }

    function log(msg, type = '') {
      const panel = document.getElementById('log-panel');
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + type;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      panel.appendChild(entry);
      panel.scrollTop = panel.scrollHeight;
      console.log(`[LINEJS] ${msg}`);
    }

    function toggleLog() {
      document.getElementById('log-panel').classList.toggle('open');
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function setStatus(msg) {
      document.getElementById('status-bar').textContent = msg;
    }

    function setOnline(online) {
      const dot = document.getElementById('status-dot');
      dot.classList.toggle('online', online);
    }

    const CRED_KEY = 'line_credentials';

    // Initialize WASM and attempt auto-login from saved credentials
    async function initWasm() {
      try {
        await init();
        client = new LineClient();
        log('WASM runtime initialized', 'success');

        // Try auto-login from saved credentials
        const saved = localStorage.getItem(CRED_KEY);
        if (saved) {
          try {
            client.loginWithToken(saved);

            // Update UI dropdown to match saved device type
            try {
              const parsed = JSON.parse(saved);
              if (parsed.deviceType) {
                const select = document.getElementById('device-mode');
                if (parsed.deviceType === 'desktop') {
                  select.value = 'desktop';
                } else {
                  select.value = 'ipad';
                }
                log('Restored device mode: ' + parsed.deviceType);
              }
            } catch (e) {
              console.warn('Failed to parse saved device type', e);
            }

            log('Session restored from saved credentials', 'success');
            setStatus('Logged in - Listening for messages');
            setOnline(true);
            document.getElementById('btn-logout').style.display = '';
            showScreen('chat-screen');
            addSystemMessage('Session restored. Listening for messages...');
            addSystemMessage('Session restored. Listening for messages...');
            startMessagePolling(++msgPollGen);
            return;
          } catch (e) {
            log('Auto-login failed (token may be expired): ' + e, 'error');
            localStorage.removeItem(CRED_KEY);
            // Fall through to show login screen
          }
        }

        setStatus('Ready to login');
      } catch (e) {
        setStatus('Failed to initialize WASM');
        log('WASM init error: ' + e, 'error');
      }
    }

    async function startLogin() {
      if (!client) return;

      const deviceMode = document.getElementById('device-mode').value;
      if (client.setDevice) {
        client.setDevice(deviceMode);
        log('Set device mode to: ' + deviceMode);
      } else {
        log('setDevice method not found on client', 'warn');
      }

      const btn = document.getElementById('btn-login');
      btn.disabled = true;
      btn.textContent = 'Connecting...';
      setStatus('Creating login session (QR & Email)...');
      log('Starting combined login flow...');

      const currentGen = ++loginGen;

      try {
        const resultStr = await client.createQrLogin();
        // Check if cancelled during await
        if (currentGen !== loginGen) {
          log('Login flow cancelled during creation', 'warn');
          return;
        }

        const result = JSON.parse(resultStr);
        log('QR code generated', 'success');

        // Show Combined screen
        showScreen('combined-screen');

        // Update QR image in combined screen
        document.getElementById('qr-image-combined').src = result.qrImageUrl;
        document.getElementById('qr-link-combined').href = result.url;

        // Ensure email inputs are cleared or ready
        document.getElementById('email-input-combined').value = '';
        document.getElementById('password-input-combined').value = '';
        checkCombinedLoginInputs();

        setStatus('Scan QR code OR enter Email/Password');

        // Poll for QR verification
        pollQrVerification(currentGen);
      } catch (e) {
        log('Login error: ' + e, 'error');
        // If error specifically mentions timeout (which it might not in create phase), just fail
        // But if createQrLogin failing is different, we handle it here.
        setStatus('Login failed: ' + e);
        btn.disabled = false;
        btn.textContent = 'Apply';
      }
    }

    function retryQrLogin() {
      // Hide overlays
      document.getElementById('qr-timeout-overlay').style.display = 'none';
      document.getElementById('qr-timeout-overlay-combined').style.display = 'none';

      // Reset status text style (red -> normal)
      const status = document.getElementById('qr-status');
      if (status) {
        status.textContent = 'Waiting for scan...';
        status.style.color = '';
      }

      const combinedStatusEl = document.getElementById('qr-status-combined');
      if (combinedStatusEl) {
        // Reset to initial helpful text or waiting text
        combinedStatusEl.textContent = 'Open LINE on your phone and scan this code';
        combinedStatusEl.style.color = '#666'; // Reset color explicitly or empty
        combinedStatusEl.style.color = '';
      }

      // Restart login flow
      startLogin();
    }

    function showQrTimeout() {
      log('QR login timed out', 'warn');
      // Show overlays
      document.getElementById('qr-timeout-overlay').style.display = 'flex';
      document.getElementById('qr-timeout-overlay-combined').style.display = 'flex';

      // Update status text
      const timeoutMsg = 'Action required: Tap to regenerate QR Code';

      const statusEl = document.getElementById('qr-status');
      if (statusEl) {
        statusEl.textContent = timeoutMsg;
        statusEl.style.color = 'var(--danger)';
      }

      const combinedStatusEl = document.getElementById('qr-status-combined');
      if (combinedStatusEl) {
        combinedStatusEl.textContent = timeoutMsg;
        combinedStatusEl.style.color = 'var(--danger)';
      }
    }

    async function pollQrVerification(gen) {
      if (gen !== loginGen) return; // Stop if new login started

      log('Waiting for QR scan...');
      document.getElementById('qr-status-combined').textContent = 'Waiting for scan...';

      try {
        const verified = await client.checkQrCodeVerified();
        if (gen !== loginGen) return;

        if (verified) {
          log('QR code scanned!', 'success');
          document.getElementById('qr-status-combined').textContent = 'Scanned!';
          setStatus('QR code scanned, verifying...');
          await handlePostScan();
        } else {
          // FALSE means timed out (180s expired without scan)
          // Show timeout UI instead of retrying
          showQrTimeout();
        }
      } catch (e) {
        log('QR verification error: ' + e, 'error');
        // Network error? Maybe retry with backoff, but simplistic: show error/timeout UI
        showQrTimeout();
      }
    }

    async function handlePostScan() {
      // Try certificate verification first
      try {
        const certOk = await client.verifyCertificate();
        if (certOk) {
          log('Certificate verified, skipping PIN', 'success');
          await completeLogin();
          return;
        }
      } catch (e) {
        log('Certificate check: ' + e);
      }

      // Need PIN code
      try {
        const pin = await client.createPinCode();
        log('PIN code: ' + pin, 'success');
        showScreen('pin-screen');
        document.getElementById('pin-display').textContent = pin;
        setStatus('Enter PIN on your mobile device');

        setStatus('Enter PIN on your mobile device');

        pollPinVerification(loginGen);
      } catch (e) {
        log('PIN creation error: ' + e, 'error');
        setStatus('PIN creation failed');
      }
    }

    async function pollPinVerification(gen) {
      if (gen !== loginGen) return;

      log('Waiting for PIN verification...');
      try {
        const verified = await client.checkPinCodeVerified();
        if (gen !== loginGen) return;

        if (verified) {
          log('PIN verified!', 'success');
          setStatus('PIN verified, logging in...');
          await completeLogin();
        } else {
          log('PIN poll timeout, retrying...');
          pollPinVerification(gen);
        }
      } catch (e) {
        log('PIN verification error: ' + e, 'error');
        setStatus('PIN verification error');
      }
    }

    async function completeLogin() {
      try {
        const token = await client.qrCodeLogin();
        log('Login successful! Token: ' + token.substring(0, 20) + '...', 'success');

        // Save credentials to localStorage for next visit
        const creds = client.exportCredentials();
        if (creds) {
          localStorage.setItem(CRED_KEY, creds);
          log('Credentials saved to localStorage', 'success');
        }

        setStatus('Logged in - Listening for messages');
        setOnline(true);
        document.getElementById('btn-logout').style.display = '';

        showScreen('chat-screen');
        addSystemMessage('Connected! Listening for messages...');

        // Start message polling
        // Start message polling
        startMessagePolling(++msgPollGen);
      } catch (e) {
        log('Login completion error: ' + e, 'error');
        setStatus('Login failed: ' + e);
      }
    }

    function startMessagePolling(gen) {
      if (gen !== msgPollGen) return;

      let pollCount = 0;
      let backoff = 200;

      async function poll() {
        if (gen !== msgPollGen) return; // Stop if invalidated

        try {
          const resultStr = await client.pollMessages();
          const messages = JSON.parse(resultStr);

          // Reset backoff on success
          backoff = 200;

          for (const msg of messages) {
            addChatMessage(msg.text, msg.isSend, msg.from, msg.to, msg.fromName, msg.toName, msg.fromPic, msg.toPic);
            log(`Message: [${msg.fromName || msg.from} -> ${msg.toName || msg.to}] ${msg.text}`);
          }

          // Re-save credentials every 10 polls to persist newly discovered peer keys
          pollCount++;
          if (pollCount % 10 === 0) {
            const creds = client.exportCredentials();
            if (creds) {
              localStorage.setItem(CRED_KEY, creds);
            }
          }

          setOnline(true);
          setStatus('Logged in - Listening for messages');
        } catch (e) {
          const errStr = String(e);
          log('Poll error: ' + errStr, 'error');

          // Detect token expiry / auth errors ‚Üí clear credentials and revert to login
          if (errStr.includes('AUTHENTICATION_DIVESTED_BY_OTHER_DEVICE') ||
            errStr.includes('NOT_AUTHORIZED') ||
            errStr.includes('AUTHENTICATION_FAILED')) {
            log('Session expired, clearing credentials', 'error');
            localStorage.removeItem(CRED_KEY);
            setOnline(false);
            document.getElementById('btn-logout').style.display = 'none';
            document.getElementById('btn-login').disabled = false;
            document.getElementById('btn-login').textContent = 'Apply';
            showScreen('login-screen');
            setStatus('Session expired. Please login again');
            addSystemMessage('Session expired. Please login again.');
            return; // Stop polling
          }

          // Network / proxy errors ‚Üí keep credentials, back off and retry
          setOnline(false);
          setStatus('Offline - Retrying in ' + Math.round(backoff / 1000) + 's...');
          backoff = Math.min(backoff * 2, 30000); // Max 30s backoff
        }

        setTimeout(poll, backoff);
      }

      poll();
    }

    function isAtBottom(container) {
      return container.scrollHeight - container.scrollTop - container.clientHeight < 50;
    }

    function addSystemMessage(text) {
      const container = document.getElementById('messages-container');
      const div = document.createElement('div');
      div.className = 'message system';
      div.textContent = text;
      container.appendChild(div);
      // Always scroll to bottom for system messages (e.g. first login)
      container.scrollTop = container.scrollHeight;
    }

    function addChatMessage(text, isSend, from, to, fromName, toName, fromPic, toPic) {
      const container = document.getElementById('messages-container');
      // Check if user is at bottom BEFORE appending
      const shouldScroll = isAtBottom(container);

      const div = document.createElement('div');
      div.className = 'message ' + (isSend ? 'sent' : 'received');
      // Show avatar + sender name as title header for received messages
      if (!isSend) {
        // Remove default padding from bubble; header and body will handle their own
        div.style.padding = '0';
        div.style.overflow = 'hidden';

        const headerRow = document.createElement('div');
        headerRow.style.cssText = 'display:flex; align-items:center; gap:8px; padding:8px 14px; background:linear-gradient(135deg, #e8f5e9, #f1f8e9); border-bottom:1px solid rgba(6,199,85,0.15);';

        // Avatar to picturePath
        const pic = toPic;
        if (pic) {
          const avatar = document.createElement('img');
          avatar.src = 'https://profile.line-scdn.net' + pic + '/preview';
          avatar.style.cssText = 'width:28px; height:28px; border-radius:50%; object-fit:cover; flex-shrink:0; border:2px solid #fff; box-shadow:0 1px 3px rgba(0,0,0,0.12);';
          avatar.onerror = function () { this.style.display = 'none'; };
          headerRow.appendChild(avatar);
        }

        if (toName) {
          const nameNode = document.createElement('span');
          nameNode.style.cssText = 'font-size:12px; font-weight:700; color:#2e7d32;';
          nameNode.textContent = toName;
          headerRow.appendChild(nameNode);
        }

        div.appendChild(headerRow);

        // Wrap content + meta in a body div with its own padding
        div._bodyWrapper = document.createElement('div');
        div._bodyWrapper.style.cssText = 'padding:8px 14px;';
      }

      const textNode = document.createElement('div');
      textNode.style.whiteSpace = 'pre-wrap';
      textNode.textContent = text;

      const meta = document.createElement('div');
      meta.className = 'meta';
      // Show displayName with MID fallback
      const displayFrom = fromName || from;
      const displayTo = toName || to;
      meta.textContent = (isSend ? 'You' : displayFrom) +
        (displayTo ? ' ‚Üí ' + displayTo : '') +
        ' ¬∑ ' + new Date().toLocaleTimeString();

      // For received messages, append into body wrapper (below title header)
      const target = div._bodyWrapper || div;
      target.appendChild(textNode);
      target.appendChild(meta);
      if (div._bodyWrapper) {
        div.appendChild(div._bodyWrapper);
        delete div._bodyWrapper;
      }

      container.appendChild(div);
      // Only auto-scroll if user was already at the bottom
      if (shouldScroll) {
        container.scrollTop = container.scrollHeight;
      }
    }

    // Install service worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(() => {
        log('Service worker registered');
      }).catch(e => {
        log('SW registration failed: ' + e);
      });
    }

    // Boot
    initWasm();
  </script>
</body>

</html>